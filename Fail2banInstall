#!/usr/bin/env bash
# ============================================================
# Fail2ban 自动部署脚本（增强专业版 - 最终验收版）
# 适配：Ubuntu 20.04 / 22.04 / 24.04 / Debian 11+
# 作者：JackHONGhy
# ============================================================

set -euo pipefail

# ---------- 彩色输出 ----------
green(){ echo -e "\033[32m[OK]\033[0m $*"; }
yellow(){ echo -e "\033[33m[WARN]\033[0m $*"; }
red(){ echo -e "\033[31m[ERR]\033[0m $*" >&2; }
blue(){ echo -e "\033[36m[INFO]\033[0m $*"; }

# ---------- 必须以 root 运行 ----------
if [[ $EUID -ne 0 ]]; then
    red "请使用 sudo 或 root 运行此脚本！"
    exit 1
fi

# ---------- 1. 系统与依赖检测 ----------
blue "检查系统依赖..."

# 基础依赖 (包含 gawk 修复)
REQUIRED_PKGS="curl fail2ban python3-systemd lsb-release grep gawk"

# 安全逻辑：仅当系统不存在 sshd 时才安装 openssh-server
# 避免覆盖现有服务器的 SSH 配置
if ! command -v sshd >/dev/null 2>&1; then
    blue "未检测到 SSH 服务，将安装 openssh-server..."
    REQUIRED_PKGS="$REQUIRED_PKGS openssh-server"
fi

MISSING_PKGS=""
for pkg in $REQUIRED_PKGS; do
    if ! dpkg -s "$pkg" >/dev/null 2>&1; then
        MISSING_PKGS="$MISSING_PKGS $pkg"
    fi
done

if [[ -n "$MISSING_PKGS" ]]; then
    blue "安装缺失组件: $MISSING_PKGS"
    apt-get update -qq
    # shellcheck disable=SC2086
    apt-get install -y $MISSING_PKGS
else
    green "基础依赖已满足"
fi

UBUNTU_VERSION=$(lsb_release -rs || echo "Unknown")
green "当前系统: Ubuntu $UBUNTU_VERSION"

# ---------- 2. 智能检测 SSH 端口 ----------
blue "智能检测 SSH 端口..."

# 预检：验证 SSH 配置语法是否正确
if sshd -t >/dev/null 2>&1; then
    # 导出完整配置
    SSH_CONFIG_DUMP=$(sshd -T 2>/dev/null)
    # 提取端口，处理多端口情况，使用紧凑逗号分隔 (22,2222)
    DETECTED_PORTS=$(echo "$SSH_CONFIG_DUMP" | grep '^port ' | awk '{print $2}' | tr '\n' ',' | sed 's/,$//')
else
    yellow "警告：sshd 配置语法校验失败或服务未运行。"
    DETECTED_PORTS=""
fi

# 决策逻辑：如果有检测到端口则使用，否则回退到 22
if [[ -n "${DETECTED_PORTS:-}" ]]; then
    SSH_PORT="$DETECTED_PORTS"
    green "成功检测 SSH 端口: $SSH_PORT"
else
    SSH_PORT="22"
    yellow "无法自动获取端口，回退默认值: 22"
fi

# ---------- 3. 自动白名单 ----------
blue "配置白名单..."
IGNOREIP="127.0.0.1/8 ::1"
# 获取当前管理员连接的 IP
ADMIN_IP=$(echo "${SSH_CLIENT:-}" | awk '{print $1}')

if [[ -n "$ADMIN_IP" ]]; then
    IGNOREIP="$IGNOREIP $ADMIN_IP"
    green "已将当前连接 IP 加入白名单: $ADMIN_IP"
else
    yellow "未检测到 SSH 来源 IP (可能是控制台登录)，仅添加本机白名单"
fi

# ---------- 4. 检测 Fail2ban 版本 ----------
MODE="normal"
F2B_VER=$(fail2ban-client --version 2>/dev/null | grep -oE "v[0-9]+\.[0-9]+" || echo "v0.0")

# v0.11+ 或 v1.x 支持 aggressive 模式
if [[ "$F2B_VER" =~ v0\.11 || "$F2B_VER" =~ v1\. ]]; then
    MODE="aggressive"
fi
green "过滤模式: $MODE ($F2B_VER)"

# ---------- 5. 防火墙后端选择 ----------
blue "检测防火墙后端..."
BANACTION="iptables-multiport"

if command -v ufw >/dev/null && ufw status | grep -q "Status: active"; then
    BANACTION="ufw"
    green "检测到 UFW (Active)，使用后端: ufw"
elif command -v nft >/dev/null 2>&1; then
    BANACTION="nftables-multiport"
    green "检测到 nftables，使用后端: nftables-multiport"
else
    green "使用默认后端: iptables-multiport"
fi

# ---------- 6. systemd 日志持久化 (资源保护) ----------
blue "优化 systemd-journald 配置..."

if [[ ! -d /var/log/journal ]]; then
    mkdir -p /var/log/journal
    
    # 修改 journald.conf，确保持久化且限制大小
    # 如果配置项不存在，则追加；如果存在，则替换
    CONF="/etc/systemd/journald.conf"
    
    # 启用持久化
    if grep -q "^#*Storage=" "$CONF"; then
        sed -i 's/^#*Storage=.*/Storage=persistent/' "$CONF"
    else
        echo "Storage=persistent" >> "$CONF"
    fi

    # 限制磁盘最大占用 200M
    if grep -q "^#*SystemMaxUse=" "$CONF"; then
        sed -i 's/^#*SystemMaxUse=.*/SystemMaxUse=200M/' "$CONF"
    else
        echo "SystemMaxUse=200M" >> "$CONF"
    fi

    # 限制运行时最大占用 100M
    if grep -q "^#*RuntimeMaxUse=" "$CONF"; then
        sed -i 's/^#*RuntimeMaxUse=.*/RuntimeMaxUse=100M/' "$CONF"
    else
        echo "RuntimeMaxUse=100M" >> "$CONF"
    fi

    systemctl restart systemd-journald
    green "systemd 日志持久化已启用 (限制 200M)"
fi

# ---------- 7. 写入 Fail2ban 配置 ----------
blue "写入 Fail2ban 配置..."

JAIL_LOCAL="/etc/fail2ban/jail.local"
JAIL_SSH="/etc/fail2ban/jail.d/sshd.local"

# 备份
[[ -f "$JAIL_LOCAL" ]] && cp "$JAIL_LOCAL" "$JAIL_LOCAL.bak.$(date +%s)"

cat > "$JAIL_LOCAL" <<EOF
[DEFAULT]
ignoreip = $IGNOREIP
bantime  = 1h
findtime = 10m
maxretry = 5
backend = systemd
banaction = $BANACTION
banaction_allports = $BANACTION
EOF

cat > "$JAIL_SSH" <<EOF
[sshd]
enabled = true
port    = $SSH_PORT
filter  = sshd
mode    = $MODE
EOF

# ---------- 8. 重启 Fail2ban ----------
blue "重启 Fail2ban..."

systemctl unmask fail2ban >/dev/null 2>&1 || true

if systemctl is-active --quiet fail2ban; then
    systemctl reload fail2ban
else
    systemctl restart fail2ban
fi

systemctl enable fail2ban >/dev/null 2>&1

# ---------- 9. 清理 ----------
blue "执行系统清理..."
apt-get autoremove -y >/dev/null 2>&1
apt-get clean >/dev/null 2>&1
# 清理可能残留的安装日志
rm -f /tmp/fail2ban-install.log 2>/dev/null
green "清理完成"

# ---------- 10. 完成与验证 ----------
echo "=============================================================="
sleep 1 # 等待 Socket 准备好

if fail2ban-client ping >/dev/null 2>&1; then
    green "Fail2ban 部署成功！"
    echo -e "   - 监控端口: \033[36m$SSH_PORT\033[0m"
    echo -e "   - 封禁动作: \033[36m$BANACTION\033[0m"
    echo -e "   - 过滤模式: \033[36m$MODE\033[0m"
else
    red "Fail2ban 启动异常，请运行：journalctl -u fail2ban -n 20 --no-pager"
fi
echo "=============================================================="

# ---------- 自毁机制 (防误删) ----------
SCRIPT_PATH=$(readlink -f "$0")

read -p "是否删除此脚本以保持目录整洁? [y/N] " -n 1 -r
echo
if [[ "$REPLY" =~ ^[Yy]$ ]]; then
    rm -f "$SCRIPT_PATH"
    green "脚本已自毁"
else
    blue "脚本已保留"
fi
